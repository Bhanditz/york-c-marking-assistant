This has been hacked around a lot. Needs a lot of refactoring and tidying up (on the TODO list!)!
